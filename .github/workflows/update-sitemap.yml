name: Aggiorna Sitemap AMP

on:
  push:
    branches:
      - main
    paths:
      - 'amp/**/*.html'
      - 'amp/sitemap.xml'
  workflow_dispatch:

jobs:
  update-sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Aggiorna amp/sitemap.xml da zero con titoli e date di pubblicazione
        run: |
          # Installa pacchetti necessari
          npm install glob xmlbuilder cheerio

          # Esegui il codice Node.js
          node <<'EOF'
          const fs = require('fs');
          const glob = require('glob');
          const builder = require('xmlbuilder');
          const cheerio = require('cheerio');

          const baseUrl = 'https://amp.brunorachiele.it';
          const sitemapPath = 'amp/sitemap.xml';

          // Trova tutte le pagine AMP nella cartella amp/, ignorando sitemap.xml
          const files = glob.sync('amp/**/*.html', { ignore: ['amp/sitemap.xml'] });

          // Leggi contenuti e data di pubblicazione da ciascun file
          const pages = files.map(file => {
            const content = fs.readFileSync(file, 'utf8');
            const $ = cheerio.load(content);

            // Legge il titolo
            const title = $('title').text() || 'Articolo AMP';

            // Legge la data di pubblicazione (dal meta tag pubdate)
            const pubdate = $('meta[name="pubdate"]').attr('content') || '2000-01-01';

            return { file, title, pubdate };
          });

          // Ordina le pagine per data di pubblicazione (piÃ¹ recenti prima)
          pages.sort((a, b) => new Date(b.pubdate) - new Date(a.pubdate));

          // Costruisce l'XML della sitemap
          const urlset = builder.create('urlset', { encoding: 'UTF-8' });
          urlset.att('xmlns', 'http://www.sitemaps.org/schemas/sitemap/0.9');

          pages.forEach(page => {
            const path = page.file.replace(/\\/g, '/').replace('amp/', '');
            urlset.ele('url')
              .ele('loc', {}, `${baseUrl}/${path}`).up()
              .ele('lastmod', {}, page.pubdate).up()
              .ele('title', {}, page.title);
          });

          const xml = urlset.end({ pretty: true });
          fs.writeFileSync(sitemapPath, xml);
          console.log('amp/sitemap.xml completamente riscritto con titoli e date di pubblicazione!');
          EOF

      - name: Commit e push sitemap.xml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add amp/sitemap.xml
          git commit -m "Sovrascritta amp/sitemap.xml con titoli e date di pubblicazione" || echo "Nessuna modifica da commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
