name: Genera Pagine AMP

on:
  workflow_dispatch:
    # esecuzione manuale
  schedule:
    - cron: '0 * * * *'
  push:
    branches:
      - main

jobs:
  build-amp:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Installa dipendenze
        run: npm install fs-extra dayjs xml2js node-fetch

      - name: Genera pagine AMP
        run: |
          node -e "
          import fs from 'fs-extra';
          import path from 'path';
          import fetch from 'node-fetch';
          import xml2js from 'xml2js';
          import dayjs from 'dayjs';

          const ampDir = 'amp';
          fs.ensureDirSync(ampDir);

          const RSS_URL = 'https://feeds.feedburner.com/brunorachiele/ZOU113SCMgV';

          (async () => {
            try {
              const res = await fetch(RSS_URL);
              const xml = await res.text();
              const parser = new xml2js.Parser();
              const data = await parser.parseStringPromise(xml);
              const items = data.rss.channel[0].item;

              for (const item of items) {
                const slug = item.link[0].replace(/^https?:\/\/[^\/]+\/|\/$/g,'');
                const title = item.title[0];
                const date = dayjs(item.pubDate[0]);
                const folder = path.join(ampDir, date.format('YYYY'), date.format('MM'));
                fs.ensureDirSync(folder);

                const filePath = path.join(folder, slug+'.html');
                const html = fs.readFileSync('article.html','utf8')
                  .replace(/{{title}}/g, title)
                  .replace(/{{link}}/g, item.link[0])
                  .replace(/{{pubDate}}/g, date.format('D MMMM YYYY'))
                  .replace(/{{isoDate}}/g, date.format('YYYY-MM-DD'));

                fs.writeFileSync(filePath, html,'utf8');
                console.log('Generata pagina AMP:', filePath);
              }
            } catch(e) {
              console.error('Errore nella generazione AMP:', e);
              process.exit(1);
            }
          })();
          "

      - name: Commit e push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add amp/
          git commit -m 'Aggiornamento automatico pagine AMP' || echo 'Nessuna modifica'
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
