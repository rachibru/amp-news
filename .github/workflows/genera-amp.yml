name: Genera Pagine AMP + Sitemap + Ultimi articoli

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-amp:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Genera pagine AMP, sitemap e link ultimi articoli
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const https = require('https');

          const ampDir = 'amp';
          const outDir = 'output';

          if (!fs.existsSync(ampDir)) throw new Error('Cartella amp/ non trovata!');
          if (!fs.existsSync(outDir)) fs.mkdirSync(outDir);

          const RSS_URL = 'https://feeds.feedburner.com/brunorachiele/ZOU113SCMgV';

          function fetchRSS(url) {
            return new Promise((resolve,reject)=>{
              https.get(url,res=>{
                let data='';
                res.on('data',chunk=>data+=chunk);
                res.on('end',()=>resolve(data));
              }).on('error',err=>reject(err));
            });
          }

          fetchRSS(RSS_URL).then(xml=>{
            const items=[];
            xml.replace(/<item>([\\s\\S]*?)<\\/item>/g,(_,block)=>{
              const title=/\<title\>(.*?)\<\/title\>/.exec(block);
              const link=/\<link\>(.*?)\<\/link\>/.exec(block);
              const pubDate=/\<pubDate\>(.*?)\<\/pubDate\>/.exec(block);
              if(title && link && pubDate){
                items.push({title:title[1], link:link[1], pubDate:pubDate[1]});
              }
            });

            // Genera AMP
            for(const item of items){
              const slug=item.link.replace(/^https?:\\/\\/[^\\/]+\\/|\\/$/g,'');
              const filePath=path.join(ampDir, slug+'.html');
              let html=fs.readFileSync('article.html','utf8');
              html=html.replace(/{{title}}/g,item.title)
                       .replace(/{{link}}/g,item.link)
                       .replace(/{{pubDate}}/g,item.pubDate)
                       .replace(/{{isoDate}}/g,new Date(item.pubDate).toISOString());
              fs.writeFileSync(filePath,html,'utf8');
              console.log('Generata pagina AMP:',filePath);
            }

            // Genera sitemap.xml
            let sitemap='<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n';
            for(const item of items){
              const slug=item.link.replace(/^https?:\\/\\/[^\\/]+\\/|\\/$/g,'');
              sitemap+=`  <url>\n    <loc>https://amp.brunorachiele.it/${slug}.html</loc>\n    <lastmod>${new Date(item.pubDate).toISOString()}</lastmod>\n  </url>\n`;
            }
            sitemap+='</urlset>';
            fs.writeFileSync(path.join(outDir,'sitemap.xml'),sitemap,'utf8');
            console.log('Generata sitemap.xml');

            // Genera mini-index ultimi articoli
            let indexHtml='<ul>\n';
            for(const item of items){
              const slug=item.link.replace(/^https?:\\/\\/[^\\/]+\\/|\\/$/g,'');
              indexHtml+=`  <li><a href=\"https://amp.brunorachiele.it/${slug}.html\">${item.title}</a></li>\n`;
            }
            indexHtml+='</ul>';
            fs.writeFileSync(path.join(outDir,'ultimi.html'),indexHtml,'utf8');
            console.log('Generato mini-index ultimi articoli');

          }).catch(err=>{ console.error(err); process.exit(1); });
          "

      - name: Commit e push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add amp/ output/
          git commit -m 'Aggiornamento automatico pagine AMP + sitemap + ultimi articoli' || echo 'Nessuna modifica'
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
