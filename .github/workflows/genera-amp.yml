name: Genera Pagine AMP

on:
  workflow_dispatch:
    # esecuzione manuale
  schedule:
    - cron: '0 * * * *'
  push:
    branches:
      - main

jobs:
  build-amp:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Genera pagine AMP
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const https = require('https');
          const { parseString } = require('xml2js');

          const ampDir = 'amp';
          if (!fs.existsSync(ampDir)) fs.mkdirSync(ampDir, { recursive: true });

          const RSS_URL = 'https://feeds.feedburner.com/brunorachiele/ZOU113SCMgV';

          function fetchRSS(url) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(data));
              }).on('error', err => reject(err));
            });
          }

          (async () => {
            try {
              const xml = await fetchRSS(RSS_URL);
              parseString(xml, (err, result) => {
                if (err) throw err;
                const items = result.rss.channel[0].item;
                for (const item of items) {
                  const slug = item.link[0].replace(/^https?:\/\/[^\/]+\/|\/$/g,'');
                  const title = item.title[0];
                  const pubDate = new Date(item.pubDate[0]);
                  const yyyy = pubDate.getFullYear().toString();
                  const mm = ('0'+(pubDate.getMonth()+1)).slice(-2);

                  const folder = path.join(ampDir, yyyy, mm);
                  if (!fs.existsSync(folder)) fs.mkdirSync(folder, { recursive: true });

                  const filePath = path.join(folder, slug+'.html');
                  let html = fs.readFileSync('article.html', 'utf8');
                  html = html.replace(/{{title}}/g, title)
                             .replace(/{{link}}/g, item.link[0])
                             .replace(/{{pubDate}}/g, pubDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' }))
                             .replace(/{{isoDate}}/g, pubDate.toISOString().slice(0,10));

                  fs.writeFileSync(filePath, html, 'utf8');
                  console.log('Generata pagina AMP:', filePath);
                }
              });
            } catch(e) {
              console.error('Errore nella generazione AMP:', e);
              process.exit(1);
            }
          })();
          "

      - name: Commit e push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add amp/
          git commit -m 'Aggiornamento automatico pagine AMP' || echo 'Nessuna modifica'
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
